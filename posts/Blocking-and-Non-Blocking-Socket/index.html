<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Blocking and Non-Blocking Socket" /><meta name="author" content="Dennis" /><meta property="og:locale" content="en" /><meta name="description" content="I was recently studying Overlapped I/O and I came across the concepts of blocking and non-blocking socket. I have already known the concepts of blocking socket but I didn’t know for non-blocking socket. So, today I gonna talk about difference between blocking and non-blocking socket." /><meta property="og:description" content="I was recently studying Overlapped I/O and I came across the concepts of blocking and non-blocking socket. I have already known the concepts of blocking socket but I didn’t know for non-blocking socket. So, today I gonna talk about difference between blocking and non-blocking socket." /><link rel="canonical" href="/posts/Blocking-and-Non-Blocking-Socket/" /><meta property="og:url" content="/posts/Blocking-and-Non-Blocking-Socket/" /><meta property="og:site_name" content="OrdinaryDennis" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-10-08T00:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Blocking and Non-Blocking Socket" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Dennis" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Dennis"},"dateModified":"2023-10-09T23:52:12+09:00","datePublished":"2023-10-08T00:00:00+09:00","description":"I was recently studying Overlapped I/O and I came across the concepts of blocking and non-blocking socket. I have already known the concepts of blocking socket but I didn’t know for non-blocking socket. So, today I gonna talk about difference between blocking and non-blocking socket.","headline":"Blocking and Non-Blocking Socket","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Blocking-and-Non-Blocking-Socket/"},"url":"/posts/Blocking-and-Non-Blocking-Socket/"}</script><title>Blocking and Non-Blocking Socket | OrdinaryDennis</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="OrdinaryDennis"><meta name="application-name" content="OrdinaryDennis"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "AMS" } }, tex2jax: { inlineMath: [ ['$','$'] ], displayMath: [ ['$$','$$'], ["\[","\]"] ], processEscapes: true } }); </script> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"> </script><body data-spy="scroll" data-target="#toc" topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">OrdinaryDennis</a></div><div class="site-subtitle font-italic">Persistence rather than Excellence</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/github_username" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Blocking and Non-Blocking Socket</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Blocking and Non-Blocking Socket</h1><div class="post-meta text-muted"><div> By <em> Dennis </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2023-10-08 00:00:00 +0900" data-toggle="tooltip" data-placement="bottom" title="Sun, Oct 8, 2023, 12:00 AM +0900" >Oct 8, 2023</em> </span> <span> Updated <em class="timeago" date="2023-10-09 23:52:12 +0900 " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 9, 2023, 11:52 PM +0900" >Oct 9, 2023</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1240 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>I was recently studying Overlapped I/O and I came across the concepts of blocking and non-blocking socket. I have already known the concepts of blocking socket but I didn’t know for non-blocking socket. So, today I gonna talk about difference between blocking and non-blocking socket. <br /></p><h2>What is Blocking and Non-Blocking?</h2><p>We usually call the function to process our specific request. At that time, the function processes the request and returns the answer that we want to. What happens if the function takes a long time to process? You will have to wait for the function to return and feel like the flow has stopped. In this way, when the processing time of a function is long and it feels like the flow has stopped, it is called blocking. Otherwise, If you don’t need to wait for function to return, It is called non-blocking. <br /><br /></p><h2>Why a Socket is Blocked?</h2><p><img data-src="/assets/img/2023-10-08-Blocking-and-Non-Blocking-Socket/blockin_io_model.png" alt="blockin_io_model" width="600" class="center" data-proofer-ignore></p><p><i>http://www.masterraghu.com/subjects/np/introduction/unix_network_programming_v1.3/ch06lev1sec2.html</i></p><p>When you call the recvfrom function, control is transferred to the system. if there is no data to read, the recvfrom function don’t return and you need to wait for the function to return. At this time, the thread of application becomes Waiting. When the system receives the data from remote computer, the system copies received data from receive buffer to the memory of application (from kernel space to user space) the control is transferred from the system to application and thread becomes Running.</p><h2> The Problem of Blocking I/O Medel</h2><p>The socket handle that is made when you create socket is blocking mode basically.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>
<span class="n">SOCKET</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">);</span>

</pre></table></code></div></div><p>The server sends the packet received back to the client and outputs the size of packet received every second. But there is a problem in this code.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">clientSocket</span> <span class="o">!=</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">messageBuffer</span><span class="p">[</span><span class="n">MAX_BUFFER</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">receiveBytes</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="n">MAX_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">receiveBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Receive message : %s (%d bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="n">receiveBytes</span><span class="p">);</span>

		<span class="kt">int</span> <span class="n">sendBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span>
		<span class="p">{</span>
			<span class="n">sendBytes</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">messageBuffer</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sendBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Send message : %s (%d bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="n">sendBytes</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SOCKET_ERROR</span> <span class="o">==</span> <span class="n">sendBytes</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">WSAGetLastError</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">WSAEWOULDBLOCK</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Recv error WSAEWOULDBLOCK(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
					<span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//wait for 1 Milliseconds.</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sendBytes</span><span class="p">);</span>

		<span class="n">receiveBytesPerSec</span> <span class="o">+=</span> <span class="n">receiveBytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeGetTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - receiveBytes: %d bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">receiveBytesPerSec</span><span class="p">);</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">timeGetTime</span><span class="p">();</span>
		<span class="n">receiveBytesPerSec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>If the client does not send the packet, The server waits for it, which means that the server is blocked in the recv() function. The recv() does not return until the packet is received because the socket is in blocking mode. So the server can’t output the size of packet received every second. <br /><br /></p><h2> Non-Blocking Socket</h2><p>Making non-blocking mode socket is easy. You can change a socket from blocking mode to non-blocking mode using the ioctlsocket() function.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">//https://learn.microsoft.com/en-us/windows/win32/api/winsock/nf-winsock-ioctlsocket</span>
<span class="c1">//-------------------------</span>
<span class="c1">// Set the socket I/O mode: In this case FIONBIO</span>
<span class="c1">// enables or disables the blocking mode for the </span>
<span class="c1">// socket based on the numerical value of iMode.</span>
<span class="c1">// If arg = 0, blocking is enabled; </span>
<span class="c1">// If arg != 0, non-blocking mode is enabled.</span>
<span class="n">u_long</span> <span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">ioctlsocket</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">,</span> <span class="n">FIONBIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>
</pre></table></code></div></div><p>The code above means to change the blocking mode of client socket to non-blocking mode. Now If there are no packets in the socket’s receive buffer, recv() will returns SOCKET_ERROR(-1). The WSAGetLastError() function returns WSAEWOULDBLOCK.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span> <span class="p">(</span><span class="n">clientSocket</span> <span class="o">!=</span> <span class="n">INVALID_SOCKET</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">messageBuffer</span><span class="p">[</span><span class="n">MAX_BUFFER</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">receiveBytes</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="n">MAX_BUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">receiveBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//sending packet</span>
		<span class="n">receiveBytesPerSec</span> <span class="o">+=</span> <span class="n">receiveBytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SOCKET_ERROR</span> <span class="o">==</span> <span class="n">receiveBytes</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">WSAGetLastError</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">WSAEWOULDBLOCK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Recv error WSAEWOULDBLOCK(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeGetTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - receiveBytes: %d bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">receiveBytesPerSec</span><span class="p">);</span>
		<span class="n">startTime</span> <span class="o">=</span> <span class="n">timeGetTime</span><span class="p">();</span>
		<span class="n">receiveBytesPerSec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Because the socket is in non- blocking mode, it can output the size of packets received normally. But there is still a problem. The recv() function always returns, whether there are packets in the receive buffer or not, so you need to periodically call the recv() function. In the code above, the recv() function is continuously being called within a while loop, which can result in a highly busy state for the thread. If you reduce the frequency of recv() function calls, the response sent to the client will slow down, whereas increasing the call frequency will result in the thread being in a highly busy state. This problem can be resolved with iocp. <br /><br /></p><h2> Non-Blocking Socket(Sending packet)</h2><p>When does the send() function become blocking? To understand this, you need to know first how the send() function is processed internally when sending data with block mode socket.</p><p><img data-src="/assets/img/2023-10-08-Blocking-and-Non-Blocking-Socket/An-established-TCP-connection.png" alt="An_established_TCP_connection" width="500" class="center" data-proofer-ignore></p><p><i>https://www.researchgate.net/figure/An-established-TCP-connection_fig1_220926307</i></p><p>A kernel socket has two buffers: the first one is a send buffer to send packet and the second one is a receive buffer to receive packet. When the send() is called, the data you want to send is copied from user space to kernel space then it is appended to the end of send buffer to send data in order.</p><p>In most cases, when you call the send() function, it returns promptly. However, if there is network latency or the remote host fails to process packets, the packets in the send buffer may not be sent and the send buffer to become full. In such cases, the send() function enters a blocking state until space becomes available in the buffer.</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">//sending packet</span>
<span class="kt">int</span> <span class="n">sendBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">do</span>
<span class="p">{</span>
	<span class="n">sendBytes</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">messageBuffer</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sendBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Send message : %s (%d bytes)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">messageBuffer</span><span class="p">,</span> <span class="n">sendBytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SOCKET_ERROR</span> <span class="o">==</span> <span class="n">sendBytes</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">WSAGetLastError</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">WSAEWOULDBLOCK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"TRACE - Recv error WSAEWOULDBLOCK(%d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="n">Sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//wait for 1 Milliseconds.</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sendBytes</span><span class="p">);</span>
</pre></table></code></div></div><p>In the code above, the clientSocket is set to non-blocking mode. As a result, the send() function returns promptly, whether the send buffer is full or not. Typically, the send buffer returns the size of the packet to be sent, but if the send buffer is full, it will return SOCKET_ERROR(-1), and the WSAGetLastError() function will return WSAEWOULDBLOCK. In this code, when the send buffer is full, it waits for 1 second and then attempts to send again. When using a non-blocking mode socket like this, the logic to detect sending or receiving data failure and try it again. <br /><br /></p><h2> Conclusion</h2><p>Today, I talked about the concept of blocking and non-blocking socket. Infact, this post is intended to understand overlapped I/O which will be posted in the near future. I hope this article will help you. <br /><br /></p><h2> References</h2><p><a href="https://marmelo12.tistory.com/287">블록킹,논블록킹,동기 I/O,비동기 I/O(Overlapped I/O)</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/c/'>C++</a>, <a href='/categories/network/'>Network</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a> <a href="/tags/network/" class="post-tag no-text-decoration" >Network</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Blocking and Non-Blocking Socket - OrdinaryDennis&url=/posts/Blocking-and-Non-Blocking-Socket/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Blocking and Non-Blocking Socket - OrdinaryDennis&u=/posts/Blocking-and-Non-Blocking-Socket/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Blocking and Non-Blocking Socket - OrdinaryDennis&url=/posts/Blocking-and-Non-Blocking-Socket/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/C++-20-Concept/">C++20 Concept</a><li><a href="/posts/Blocking-and-Non-Blocking-Socket/">Blocking and Non-Blocking Socket</a><li><a href="/posts/Find-Duplicated-Elements-Between-Two-Arrays-in-C++/">Find Duplicated Elements Between Two Arrays in C++</a><li><a href="/posts/Be-careful-Try-Not-to-Use-Invalidated-Iterator/">Be careful Try Not to Use Invalidated Iterator</a><li><a href="/posts/use-empty-instread-of-size/">When Checking whether Container is Empty, Use empty() instead of Comparing size() with zero</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/stl/">STL</a> <a class="post-tag" href="/tags/blogging/">Blogging</a> <a class="post-tag" href="/tags/network/">Network</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Be-careful-Try-Not-to-Use-Invalidated-Iterator/"><div class="card-body"> <em class="timeago small" date="2023-09-10 00:00:00 +0900" >Sep 10, 2023</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Be careful Try Not to Use Invalidated Iterator</h3><div class="text-muted small"><p> Recently, there was a case of a bug while running a program using invalidated iterator in the team I work for. Today, we will find out what the iterator invalidation is and summarize the cases of i...</p></div></div></a></div><div class="card"> <a href="/posts/Find-Duplicated-Elements-Between-Two-Arrays-in-C++/"><div class="card-body"> <em class="timeago small" date="2023-09-24 00:00:00 +0900" >Sep 24, 2023</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Find Duplicated Elements Between Two Arrays in C++</h3><div class="text-muted small"><p> Someday I was wondering how to get elements which is duplicated between two arrays. So, Today I am gonna talk to you about this. Let’s see code below Approach 1: Brute Force //Approach 1: Brute ...</p></div></div></a></div><div class="card"> <a href="/posts/LeetCode-652.-Find-Duplicate-Subtrees/"><div class="card-body"> <em class="timeago small" date="2023-09-30 00:00:00 +0900" >Sep 30, 2023</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>LeetCode 652. Find Duplicate Subtrees</h3><div class="text-muted small"><p> Given the root of a binary tree, return all duplicate subtrees. For each kind of duplicate subtrees, you only need to return the root node of any one of them. Two trees are duplicate if they have t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/LeetCode-799.-Champagne-Tower/" class="btn btn-outline-primary" prompt="Older"><p>LeetCode 799. Champagne Tower</p></a> <a href="/posts/tuple/" class="btn btn-outline-primary" prompt="Newer"><p>C++ std::tuple</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/username">your_full_name</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/stl/">STL</a> <a class="post-tag" href="/tags/blogging/">Blogging</a> <a class="post-tag" href="/tags/network/">Network</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
